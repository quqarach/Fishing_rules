<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Рыбалка: можно или нет?</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
      background: #eee;
    }

    .date-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 300px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 14px;
    }

    .date-panel label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #2c3e50;
    }

    .date-panel input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .attribution-osm {
      margin-top: 10px;
      font-size: 11px;
      color: #666;
      border-top: 1px solid #eee;
      padding-top: 5px;
    }

    .legal-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #007cba;
      color: white;
      padding: 8px 16px;
      text-align: center;
      font-size: 12px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      line-height: 1.4;
    }

    .popup-info {
      font-size: 13px;
      line-height: 1.5;
    }

    .popup-info strong {
      font-weight: bold;
    }

    .popup-info .status {
      margin-top: 8px;
      font-weight: bold;
    }

    .popup-info .status.ok {
      color: #2e7d32;
    }

    .popup-info .status.error {
      color: #c62828;
    }

    .popup-info .reason {
      margin-top: 6px;
      padding: 6px;
      background-color: #fff0f0;
      border-left: 3px solid #c62828;
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>

  <!-- Верхняя плашка -->
  <div class="legal-banner">
    Согласно Приказу Министерства сельского хозяйства РФ от 9 января 2020 г. № 1<br>
    "Об утверждении правил рыболовства для Азово-Черноморского рыбохозяйственного бассейна"<br>
    (с изменениями и дополнениями от 28 июля 2025 г.)
  </div>

  <!-- Панель выбора даты -->
  <div class="date-panel">
    <label for="fishing-date">Выберите дату:</label>
    <input type="date" id="fishing-date" />

    <div class="attribution-osm">
      Данные карты: © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>
    </div>
  </div>

  <!-- Карта -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Проверка Leaflet
    if (typeof L === 'undefined') {
      document.getElementById('map').innerHTML = '<p style="color:red">Ошибка: Leaflet не загружен</p>';
    }

    // Инициализация карты
    const map = L.map('map').setView([46.5, 40.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Глобальные переменные
    let zoneLayers = [];
    let marker = null;

    // Формат даты: YYYY-MM-DD → DD.MM.YYYY
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Проверка диапазона дат
    function isDateInRange(target, startStr, endStr) {
      const start = new Date(startStr);
      const end = new Date(endStr);
      const t = new Date(target);
      t.setHours(0,0,0,0);
      start.setHours(0,0,0,0);
      end.setHours(0,0,0,0);
      return t >= start && t <= end;
    }

    // Проверка: точка в полигоне
    L.GeometryUtil = L.extend(L.GeometryUtil || {}, {
      pointInPolygon(latlng, polygonLatLngs) {
        let inside = false;
        const latlngs = polygonLatLngs[0]; // внешний контур
        for (let i = 0, j = latlngs.length - 1; i < latlngs.length; j = i++) {
          const xi = latlngs[i].lat, yi = latlngs[i].lng;
          const xj = latlngs[j].lat, yj = latlngs[j].lng;
          const intersect = ((yi > latlng.lng) !== (yj > latlng.lng)) &&
            (latlng.lat < (xj - xi) * (latlng.lng - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }
    });

    // Проверка: точка рядом с линией (в пределах N метров)
    function isPointNearLine(lat, lng, lineCoords, tolerance = 50) {
      const point = L.latLng(lat, lng);
      for (let i = 0; i < lineCoords.length - 1; i++) {
        const p1 = L.latLng(lineCoords[i][0], lineCoords[i][1]);
        const p2 = L.latLng(lineCoords[i+1][0], lineCoords[i+1][1]);

        const dx = p2.lat - p1.lat;
        const dy = p2.lng - p1.lng;
        const d2 = dx*dx + dy*dy;
        if (d2 === 0) continue;

        const t = Math.max(0, Math.min(1, ((point.lat - p1.lat)*dx + (point.lng - p1.lng)*dy) / d2));
        const proj = L.latLng(p1.lat + t*dx, p1.lng + t*dy);
        if (point.distanceTo(proj) <= tolerance) return true;
      }
      return false;
    }

    // Загрузка зон из JSON
    async function loadZones() {
      try {
        const response = await fetch('rules-zones.json');
        if (!response.ok) throw new Error(`Не удалось загрузить rules-zones.json: ${response.status}`);
        const data = await response.json();

        // Очистка старых слоёв
        zoneLayers.forEach(layer => map.removeLayer(layer));
        zoneLayers = [];

        data.local_zones.forEach(zone => {
          let layer;
          if (zone.type === 'polygon') {
            layer = L.polygon(zone.coords, {
              color: 'green',
              fillColor: '#0f0',
              fillOpacity: 0.3,
              weight: 3
            });
          } else if (zone.type === 'line') {
            layer = L.polyline(zone.coords, {
              color: 'blue',
              weight: 6,
              opacity: 0.8
            });
          } else return;

          // Сохраняем метаданные
          layer.zoneData = zone;
          layer.addTo(map);
          zoneLayers.push(layer);
        });

        // Установка даты по умолчанию
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fishing-date').value = today;
        updateZoneColors(today);
      } catch (e) {
        console.error("Ошибка загрузки зон:", e);
        alert("Не удалось загрузить правила. Проверьте файл rules-zones.json");
      }
    }

    // Обновление цвета зон в зависимости от даты
    function updateZoneColors(dateStr) {
      const date = new Date(dateStr);
      zoneLayers.forEach(layer => {
        const zone = layer.zoneData;
        const isActive = isDateInRange(date, zone.start, zone.end);
        const color = isActive ? 'red' : 'green';
        const fillColor = isActive ? '#f00' : '#0f0';
        layer.setStyle({ color, fillColor });
      });
    }

    // Обработчик клика по карте
    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      const dateStr = document.getElementById('fishing-date').value;
      const date = new Date(dateStr);

      // Удаляем старую метку
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);

      let locationName = null;
      let isRestricted = false;
      let restrictionRule = null;

      // Проверяем все зоны
      for (const layer of zoneLayers) {
        const zone = layer.zoneData;
        const isActivePeriod = isDateInRange(date, zone.start, zone.end);
        let isInside = false;

        if (zone.type === 'polygon') {
          isInside = L.GeometryUtil.pointInPolygon(e.latlng, layer.getLatLngs());
        } else if (zone.type === 'line') {
          isInside = isPointNearLine(lat, lng, zone.coords, 50); // 50 метров
        }

        if (isInside && isActivePeriod) {
          locationName = zone.name;
          isRestricted = true;
          restrictionRule = zone.rule; // ← Берём правило из JSON
          break; // Достаточно первого совпадения
        }
      }

      // Формируем popup
      const locText = locationName ? `<strong>Локация:</strong> ${locationName}<br>` : '';
      const status = isRestricted
        ? '<span class="status error">❌ Рыбалка запрещена.</span>'
        : '<span class="status ok">✅ Рыбалка разрешена.</span>';

      const reason = isRestricted
        ? `<div class="reason"><strong>Причина:</strong><br>${restrictionRule}</div>`
        : '';

      marker.bindPopup(`
        <div class="popup-info">
          <strong>Координаты:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
          ${locText}
          <strong>Дата:</strong> ${formatDate(dateStr)}<br>
          <strong>Ограничения:</strong><br>
          ${status}
          ${reason}
        </div>
      `).openPopup();
    });

    // При изменении даты
    document.getElementById('fishing-date').addEventListener('change', function() {
      updateZoneColors(this.value);
    });

    // Загрузка при старте
    loadZones();
  </script>
</body>
</html>
