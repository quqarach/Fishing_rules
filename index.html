<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†—ã–±–∞–ª–∫–∞: –º–æ–∂–Ω–æ –∏–ª–∏ –Ω–µ—Ç?</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
      background: #eee;
    }

    .date-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 300px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 14px;
    }

    .date-panel label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #2c3e50;
    }

    .date-panel input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .restrictions-list {
      margin-top: 10px;
    }

    .restriction-item {
      margin-bottom: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }

    .restriction-title {
      background-color: #f8f8f8;
      padding: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #c62828;
      font-size: 13px;
      margin: 0;
    }

    .restriction-title:hover {
      background-color: #eee;
    }

    .restriction-content {
      padding: 10px;
      background-color: #fff9f9;
      border-top: 1px dashed #ccc;
      display: none;
      font-size: 12px;
      line-height: 1.4;
    }

    .popup-info {
      font-size: 13px;
      line-height: 1.5;
    }

    .attribution-osm {
      margin-top: 10px;
      font-size: 11px;
      color: #666;
      border-top: 1px solid #eee;
      padding-top: 5px;
    }
  </style>
</head>
<body>

  <div class="date-panel">
    <label for="fishing-date">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
    <input type="date" id="fishing-date" />

    <h4 style="margin: 12px 0 6px 0; color: #2c3e50;">–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—Ä–µ—Ç—ã:</h4>
    <div id="restrictions-list">
      <p style="color: #999; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª...</p>
    </div>

    <div class="attribution-osm">
      –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã: ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    if (typeof L === 'undefined') {
      console.error("Leaflet –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
      document.getElementById('map').innerHTML = '<p style="color:red; text-align:center;">–û—à–∏–±–∫–∞: –∫–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (Leaflet)</p>';
    }

    const map = L.map('map', {
      attributionControl: false
    }).setView([46.05, 40.5], 10); // –¶–µ–Ω—Ç—Ä –æ–∫–æ–ª–æ —Ç–µ—Å—Ç–æ–≤–æ–π –ª–∏–Ω–∏–∏

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let fullRestrictions = [];
    let localZones = [];
    let zoneLayers = [];
    let marker = null;

    function isDateInRange(date, startMMDD, endMMDD) {
      const year = date.getFullYear();
      const start = new Date(`${year}-${startMMDD}`);
      let end = new Date(`${year}-${endMMDD}`);
      if (end < start) end.setFullYear(year + 1);
      const target = new Date(date);
      target.setHours(0, 0, 0, 0);
      return target >= start && target <= end;
    }

    L.GeometryUtil = L.extend(L.GeometryUtil || {}, {
      contains: function(polygon, latlng) {
        const polyPoints = polygon.getLatLngs()[0];
        let inside = false;
        for (let i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
          const xi = polyPoints[i].lat, yi = polyPoints[i].lng;
          const xj = polyPoints[j].lat, yj = polyPoints[j].lng;
          const intersect = ((yi > latlng.lng) !== (yj > latlng.lng)) &&
            (latlng.lat < (xj - xi) * (latlng.lng - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }
    });

    // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –±–ª–∏–∑–∫–æ –ª–∏ –∫ –ª–∏–Ω–∏–∏ (–≤ –º–µ—Ç—Ä–∞—Ö)
    function isPointNearLine(lat, lng, lineCoords, toleranceMeters = 50) {
      const point = L.latLng(lat, lng);
      for (let i = 0; i < lineCoords.length - 1; i++) {
        const p1 = L.latLng(lineCoords[i][0], lineCoords[i][1]);
        const p2 = L.latLng(lineCoords[i + 1][0], lineCoords[i + 1][1]);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é Leaflet (–Ω–µ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        if (typeof L.LineUtil.closestPointOnSegment === 'function') {
          const closest = L.LineUtil.closestPointOnSegment(point, p1, p2);
          const distance = point.distanceTo(closest);
          if (distance <= toleranceMeters) return true;
        } else {
          // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç
          const A = point.lat - p1.lat;
          const B = point.lng - p1.lng;
          const C = p2.lat - p1.lat;
          const D = p2.lng - p1.lng;
          const dot = A * C + B * D;
          const lenSq = C * C + D * D;
          let param = lenSq === 0 ? 0 : dot / lenSq;

          let xx, yy;
          if (param < 0) {
            xx = p1.lat;
            yy = p1.lng;
          } else if (param > 1) {
            xx = p2.lat;
            yy = p2.lng;
          } else {
            xx = p1.lat + param * C;
            yy = p1.lng + param * D;
          }

          const dx = point.lat - xx;
          const dy = point.lng - yy;
          const distance = Math.sqrt(dx * dx + dy * dy) * 111319; // –≥—Ä–∞–¥—É—Å—ã ‚Üí –º–µ—Ç—Ä—ã
          if (distance <= toleranceMeters) return true;
        }
      }
      return false;
    }

    // üîß –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤–º–µ—Å—Ç–æ JSON)
    fullRestrictions = [
      {
        name: "–ó–∞–ø—Ä–µ—Ç –≤ –Ω–µ—Ä–µ—Å—Ç",
        start: "04-01",
        end: "06-15",
        rule: "–ó–∞–ø—Ä–µ—â–µ–Ω–∞ –ª—é–±–∞—è —Ä—ã–±–∞–ª–∫–∞ –≤ –Ω–µ—Ä–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥",
        period: (date) => isDateInRange(date, "04-01", "06-15")
      }
    ];

    localZones = [
      // –¢–µ—Å—Ç–æ–≤–∞—è –∑–æ–Ω–∞-–ø–æ–ª–∏–≥–æ–Ω
      {
        name: "–û–∑–µ—Ä–æ –õ–µ–±—è–∂—å–µ",
        type: "polygon",
        coords: [
          [46.0, 40.0],
          [46.0, 40.1],
          [46.1, 40.1],
          [46.1, 40.0]
        ],
        start: "04-01",
        end: "06-15",
        rule: "–ó–∞–ø—Ä–µ—â–µ–Ω–∞ —Ä—ã–±–∞–ª–∫–∞ –≤ –æ–∑–µ—Ä–µ –≤ –Ω–µ—Ä–µ—Å—Ç",
        period: (date) => isDateInRange(date, "04-01", "06-15")
      },
      // –¢–µ—Å—Ç–æ–≤–∞—è –∑–æ–Ω–∞-–ª–∏–Ω–∏—è (—Ä–µ–∫–∞)
      {
        name: "–†–µ–∫–∞ –¢–µ—Å—Ç–æ–≤–∞—è",
        type: "line",
        coords: [
          [46.05, 40.4],
          [46.06, 40.5],
          [46.07, 40.6]
        ],
        start: "04-01",
        end: "06-15",
        rule: "–ó–∞–ø—Ä–µ—â–µ–Ω–∞ —Ä—ã–±–∞–ª–∫–∞ –Ω–∞ —É—á–∞—Å—Ç–∫–µ —Ä–µ–∫–∏",
        period: (date) => isDateInRange(date, "04-01", "06-15")
      }
    ];

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç—É
    function addZonesToMap() {
      zoneLayers.forEach(item => {
        if (map.hasLayer(item.layer)) map.removeLayer(item.layer);
      });
      zoneLayers = [];

      localZones.forEach(zone => {
        let layer;
        if (zone.type === "polygon") {
          layer = L.polygon(zone.coords, {
            color: 'green',
            fillColor: '#0f0',
            fillOpacity: 0.3,
            weight: 3
          });
        } else if (zone.type === "line") {
          layer = L.polyline(zone.coords, {
            color: 'blue',
            weight: 8,
            opacity: 0.7
          });
        }
        layer.addTo(map);
        zoneLayers.push({ layer, zone });
      });
    }

    function updateZoneColors(date) {
      zoneLayers.forEach(item => {
        const color = item.zone.period(date) ? 'red' : 'green';
        const fillColor = item.zone.period(date) ? '#f00' : '#0f0';
        item.layer.setStyle({ color, fillColor });
      });
    }

    function updateRestrictions(date) {
      const container = document.getElementById('restrictions-list');
      container.innerHTML = '';
      const active = fullRestrictions.filter(r => r.period(date));
      if (active.length === 0) {
        container.innerHTML = '<p style="color: #999;">–ù–µ—Ç –æ–±—â–∏—Ö –∑–∞–ø—Ä–µ—Ç–æ–≤</p>';
      } else {
        active.forEach(r => {
          const item = document.createElement('div');
          item.className = 'restriction-item';
          const title = document.createElement('h5');
          title.className = 'restriction-title';
          title.textContent = r.name;
          const content = document.createElement('div');
          content.className = 'restriction-content';
          content.innerHTML = r.rule;
          title.onclick = () => {
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
          };
          item.appendChild(title);
          item.appendChild(content);
          container.appendChild(item);
        });
      }
    }

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      const dateStr = document.getElementById('fishing-date').value;
      const date = new Date(dateStr);

      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);

      let locationName = null;
      let restrictions = [];

      zoneLayers.forEach(item => {
        const { layer, zone } = item;
        let isInside = false;
        if (zone.type === "polygon") {
          isInside = L.GeometryUtil.contains(layer, e.latlng);
        } else if (zone.type === "line") {
          isInside = isPointNearLine(lat, lng, zone.coords, 50); // 50 –º–µ—Ç—Ä–æ–≤
        }
        if (isInside) {
          locationName = zone.name;
          if (zone.period(date)) {
            restrictions.push(`<strong style="color: red;">‚ö†Ô∏è ${zone.name}</strong>: ${zone.rule}`);
          }
        }
      });

      const loc = locationName
        ? `<strong>–õ–æ–∫–∞—Ü–∏—è:</strong> ${locationName}<br>`
        : `<strong>–õ–æ–∫–∞—Ü–∏—è:</strong> –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞<br>`;
      const status = restrictions.length > 0 ? restrictions.join("<br>") : "‚úÖ –†—ã–±–∞–ª–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞.";

      marker.bindPopup(`
        <div class="popup-info">
          <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
          ${loc}
          <strong>–î–∞—Ç–∞:</strong> ${dateStr}<br>
          <strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</strong><br>
          ${status}
        </div>
      `).openPopup();
    });

    document.getElementById('fishing-date').addEventListener('change', function() {
      const date = new Date(this.value);
      updateRestrictions(date);
      updateZoneColors(date);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    addZonesToMap();
    const today = new Date();
    document.getElementById('fishing-date').value = today.toISOString().slice(0, 10);
    updateRestrictions(today);
    updateZoneColors(today);
  </script>
</body>
</html>
